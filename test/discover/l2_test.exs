# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

defmodule Giraphe.Discover.L2Test do
  use ExUnit.Case
  doctest Giraphe.Discover.L2

  import Giraphe.Discover.L2
  import NetAddr,
    only: [ip: 1, mac_48: 1]

  alias Giraphe.Switch

  test "Returns list of switches" do
    expected_switches =
      [ %Switch{
          name: "192.0.2.3",
          polladdr: ip("192.0.2.3"),
          physaddr: mac_48("00:00:00:00:00:03"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:07"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:10"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:20"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:30"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:40"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:50"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:51"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:52"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:53"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:54"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:55"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:56"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:57"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:58"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:59"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:60"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:70"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:80"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:90"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:00"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:02"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:03"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:04"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:05"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:06"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:07"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:08"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:09"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:10"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:20"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:30"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:40"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:50"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:60"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:70"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:80"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:90"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:02:00"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.7",
          polladdr: ip("192.0.2.7"),
          physaddr: mac_48("00:00:00:00:00:07"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:10"), 1},
            {"Gi1/2",  mac_48("00:00:00:00:00:20"), 1},
            {"Gi1/3",  mac_48("00:00:00:00:00:30"), 1},
            {"Gi1/4",  mac_48("00:00:00:00:00:40"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:50"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:51"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:52"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:53"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:54"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:55"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:56"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:57"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:58"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:59"), 1},
            {"Gi1/6",  mac_48("00:00:00:00:00:60"), 1},
            {"Gi1/7",  mac_48("00:00:00:00:00:70"), 1},
            {"Gi1/8",  mac_48("00:00:00:00:00:80"), 1},
            {"Gi1/9",  mac_48("00:00:00:00:00:90"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:00"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:01"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:02"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:03"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:04"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:05"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:06"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:07"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:08"), 1},
            {"Gi1/10", mac_48("00:00:00:00:01:09"), 1},
            {"Gi1/11", mac_48("00:00:00:00:01:10"), 1},
            {"Gi1/12", mac_48("00:00:00:00:01:20"), 1},
            {"Gi1/13", mac_48("00:00:00:00:01:30"), 1},
            {"Gi1/14", mac_48("00:00:00:00:01:40"), 1},
            {"Gi1/15", mac_48("00:00:00:00:01:50"), 1},
            {"Gi1/16", mac_48("00:00:00:00:01:60"), 1},
            {"Gi1/17", mac_48("00:00:00:00:01:70"), 1},
            {"Gi1/18", mac_48("00:00:00:00:01:80"), 1},
            {"Gi1/19", mac_48("00:00:00:00:01:90"), 1},
            {"Gi1/20", mac_48("00:00:00:00:02:00"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.10",
          polladdr: ip("192.0.2.10"),
          physaddr: mac_48("00:00:00:00:00:10"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.20",
          polladdr: ip("192.0.2.20"),
          physaddr: mac_48("00:00:00:00:00:20"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.30",
          polladdr: ip("192.0.2.30"),
          physaddr: mac_48("00:00:00:00:00:30"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.40",
          polladdr: ip("192.0.2.40"),
          physaddr: mac_48("00:00:00:00:00:40"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.50",
          polladdr: ip("192.0.2.50"),
          physaddr: mac_48("00:00:00:00:00:50"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:51"), 1},
            {"Gi1/2",  mac_48("00:00:00:00:00:52"), 1},
            {"Gi1/3",  mac_48("00:00:00:00:00:53"), 1},
            {"Gi1/4",  mac_48("00:00:00:00:00:54"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:55"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:56"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:57"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:58"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:00:59"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.51",
          polladdr: ip("192.0.2.51"),
          physaddr: mac_48("00:00:00:00:00:51"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.52",
          polladdr: ip("192.0.2.52"),
          physaddr: mac_48("00:00:00:00:00:52"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.53",
          polladdr: ip("192.0.2.53"),
          physaddr: mac_48("00:00:00:00:00:53"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.54",
          polladdr: ip("192.0.2.54"),
          physaddr: mac_48("00:00:00:00:00:54"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.55",
          polladdr: ip("192.0.2.55"),
          physaddr: mac_48("00:00:00:00:00:55"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:00:56"), 1},
            {"Gi1/2",  mac_48("00:00:00:00:00:57"), 1},
            {"Gi1/3",  mac_48("00:00:00:00:00:58"), 1},
            {"Gi1/4",  mac_48("00:00:00:00:00:59"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.56",
          polladdr: ip("192.0.2.56"),
          physaddr: mac_48("00:00:00:00:00:56"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.57",
          polladdr: ip("192.0.2.57"),
          physaddr: mac_48("00:00:00:00:00:57"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.58",
          polladdr: ip("192.0.2.58"),
          physaddr: mac_48("00:00:00:00:00:58"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.59",
          polladdr: ip("192.0.2.59"),
          physaddr: mac_48("00:00:00:00:00:59"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.60",
          polladdr: ip("192.0.2.60"),
          physaddr: mac_48("00:00:00:00:00:60"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.70",
          polladdr: ip("192.0.2.70"),
          physaddr: mac_48("00:00:00:00:00:70"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.80",
          polladdr: ip("192.0.2.80"),
          physaddr: mac_48("00:00:00:00:00:80"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.90",
          polladdr: ip("192.0.2.90"),
          physaddr: mac_48("00:00:00:00:00:90"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.100",
          polladdr: ip("192.0.2.100"),
          physaddr: mac_48("00:00:00:00:01:00"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
            {"Gi1/1",  mac_48("00:00:00:00:01:01"), 1},
            {"Gi1/2",  mac_48("00:00:00:00:01:02"), 1},
            {"Gi1/3",  mac_48("00:00:00:00:01:03"), 1},
            {"Gi1/4",  mac_48("00:00:00:00:01:04"), 1},
            {"Gi1/5",  mac_48("00:00:00:00:01:05"), 1},
            {"Gi1/6",  mac_48("00:00:00:00:01:06"), 1},
            {"Gi1/7",  mac_48("00:00:00:00:01:07"), 1},
            {"Gi1/8",  mac_48("00:00:00:00:01:08"), 1},
            {"Gi1/9",  mac_48("00:00:00:00:01:09"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.101",
          polladdr: ip("192.0.2.101"),
          physaddr: mac_48("00:00:00:00:01:01"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.102",
          polladdr: ip("192.0.2.102"),
          physaddr: mac_48("00:00:00:00:01:02"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.103",
          polladdr: ip("192.0.2.103"),
          physaddr: mac_48("00:00:00:00:01:03"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.104",
          polladdr: ip("192.0.2.104"),
          physaddr: mac_48("00:00:00:00:01:04"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.105",
          polladdr: ip("192.0.2.105"),
          physaddr: mac_48("00:00:00:00:01:05"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.106",
          polladdr: ip("192.0.2.106"),
          physaddr: mac_48("00:00:00:00:01:06"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.107",
          polladdr: ip("192.0.2.107"),
          physaddr: mac_48("00:00:00:00:01:07"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.108",
          polladdr: ip("192.0.2.108"),
          physaddr: mac_48("00:00:00:00:01:08"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.109",
          polladdr: ip("192.0.2.109"),
          physaddr: mac_48("00:00:00:00:01:09"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.110",
          polladdr: ip("192.0.2.110"),
          physaddr: mac_48("00:00:00:00:01:10"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.120",
          polladdr: ip("192.0.2.120"),
          physaddr: mac_48("00:00:00:00:01:20"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.130",
          polladdr: ip("192.0.2.130"),
          physaddr: mac_48("00:00:00:00:01:30"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.140",
          polladdr: ip("192.0.2.140"),
          physaddr: mac_48("00:00:00:00:01:40"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.150",
          polladdr: ip("192.0.2.150"),
          physaddr: mac_48("00:00:00:00:01:50"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.160",
          polladdr: ip("192.0.2.160"),
          physaddr: mac_48("00:00:00:00:01:60"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.170",
          polladdr: ip("192.0.2.170"),
          physaddr: mac_48("00:00:00:00:01:70"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.180",
          polladdr: ip("192.0.2.180"),
          physaddr: mac_48("00:00:00:00:01:80"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.190",
          polladdr: ip("192.0.2.190"),
          physaddr: mac_48("00:00:00:00:01:90"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
        %Switch{
          name: "192.0.2.200",
          polladdr: ip("192.0.2.200"),
          physaddr: mac_48("00:00:00:00:02:00"),
          uplink: "Gi1/24",
          fdb: [
            {"Gi1/24", mac_48("00:00:00:00:00:01"), 1},
          ]
        },
      ]

    switches =
      discover_switches(ip("192.0.2.1"), nil)

    assert switches == expected_switches
  end
end
